<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¥• ë‹¹ - ìˆ™ì œ ê´€ë¦¬ì</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
    body {
        background: #FFF5E8;
        font-family: Pretendard, sans-serif;
        margin: 0;
        padding: 20px;
    }

    h1 {
        text-align: center;
        color: #ff8a3c;
        margin-bottom: 5px;
    }

    .tag {
        text-align: center;
        font-size: 13px;
        color: #fff;
        background: #ffb37a;
        padding: 4px 12px;
        border-radius: 999px;
        display: inline-block;
        margin-left: 50%;
        transform: translateX(-50%);
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 6px;
        color: #ff8a3c;
        margin-top: 20px;
    }

    textarea {
        width: 100%;
        min-height: 70px;
        border-radius: 8px;
        border: 1px solid #ffcfac;
        padding: 10px;
        resize: vertical;
        font-family: inherit;
        background: #fff;
    }

    .box {
        background: white;
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(255,150,95,0.2);
        margin-bottom: 25px;
    }

    .add-box {
        margin: 10px 0 20px 0;
        display: flex;
        gap: 10px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: #ffffff;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 3px 12px rgba(255,150,95,0.25);
    }

    th {
        background: #ffb37a;
        padding: 8px;
        color: #fff;
        font-weight: 600;
        text-align: center;
    }

    td {
        border-bottom: 1px solid #ffe1cc;
        padding: 6px;
        text-align: center;
    }

    input[type="text"] {
        padding: 6px;
        border-radius: 8px;
        border: 1px solid #ffd1a4;
        width: 90%;
    }

    .delete-btn {
        background: #ffe1cc;
        border: none;
        color: #ff6b3b;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 6px;
        cursor: pointer;
    }

    button {
        padding: 10px 14px;
        border: none;
        border-radius: 10px;
        background: #ff8a3c;
        color: white;
        font-weight: 600;
        cursor: pointer;
    }

</style>
</head>

<body>

<h1>ğŸ¥• ë‹¹ - ìˆ™ì œ ê´€ë¦¬ì</h1>
<div class="tag">ê´€ë¦¬ì ID: ë‹¹ (ì£¼í™©)</div>

<!-- ì˜¤ëŠ˜ì˜ í•œë§ˆë”” -->
<div class="box">
    <div class="section-title">ğŸ¥• ì˜¤ëŠ˜ì˜ í•œë§ˆë”” (ê´€ë¦¬ìê°€ ì‚¬ìš©ìì—ê²Œ)</div>
    <textarea id="adminMessage" placeholder="ì‚¬ìš©ìì—ê²Œ ë‚¨ê¸¸ ë©”ì‹œì§€"></textarea>
    <button onclick="saveAdminMessage()">ì €ì¥</button>
</div>

<div class="box">
    <div class="section-title">ğŸ° ì‚¬ìš©ì í•œë§ˆë””</div>
    <div id="userMessageBox" style="white-space:pre-line; padding:10px; background:#fff7f2; border-radius:8px; border:1px solid #ffd7c2;">
        (ì•„ì§ ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤)
    </div>
</div>

<!-- í•­ëª© ì¶”ê°€ -->
<div class="section-title">ğŸ“Œ í•­ëª© ê´€ë¦¬</div>
<div class="add-box">
    <input type="text" id="newField" placeholder="ìƒˆ í•­ëª© ì´ë¦„ (ì˜ˆ: ë°©ì…€)">
    <button onclick="addField()">í•­ëª© ì¶”ê°€</button>
</div>

<table id="table">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
</table>

<script>
/* Firebase Setup */
const firebaseConfig = {
    apiKey: "AIzaSyAHmLNi5VOuAE-gXnAg-fEfzylPZvzvfVo",
    authDomain: "daily-checklist-91e5a.firebaseapp.com",
    projectId: "daily-checklist-91e5a",
    storageBucket: "daily-checklist-91e5a.firebasestorage.app",
    messagingSenderId: "66394691958",
    appId: "1:66394691958:web:cf91f295456a2e10d18257",
    measurementId: "G-87WK4N4EGH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const configRef = db.collection("config").doc("checklist");
const spacesRef = db.collection("spaces");
const todayRef = db.collection("today").doc("messages");

let fields = [];

/* ì˜¤ëŠ˜ í•œë§ˆë”” ì‹¤ì‹œê°„ */
todayRef.onSnapshot(doc => {
    if (doc.exists) {
        document.getElementById("userMessageBox").innerText =
            doc.data().userMessage || "(ì•„ì§ ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤)";
    }
});

/* í•­ëª© ì‹¤ì‹œê°„ */
configRef.onSnapshot(doc => {
    if (doc.exists) {
        fields = doc.data().fields;
        renderTable();
    }
});

/* í–‰ ì‹¤ì‹œê°„ */
spacesRef.onSnapshot(() => renderTable());

/* ê´€ë¦¬ì ë©”ì‹œì§€ ì €ì¥ */
function saveAdminMessage() {
    const msg = document.getElementById("adminMessage").value;
    todayRef.set(
        { adminMessage: msg, date: new Date().toISOString() },
        { merge: true }
    );
}

/* í•­ëª© ì¶”ê°€ */
function addField() {
    const newField = document.getElementById("newField").value.trim();
    if (!newField) return;

    configRef.update({
        fields: firebase.firestore.FieldValue.arrayUnion(newField)
    });

    document.getElementById("newField").value = "";
}

/* í•­ëª© ì‚­ì œ */
function deleteField(name) {
    configRef.update({
        fields: firebase.firestore.FieldValue.arrayRemove(name)
    });
}

/* í–‰ ì¶”ê°€ */
function addRow() {
    const nick = prompt("ë‹‰ë„¤ì„ ì…ë ¥:");
    if (!nick) return;

    const uid = prompt("ì•„ì´ë”” ì…ë ¥:");
    if (!uid) return;

    spacesRef.add({
        nickname: nick,
        userid: uid,
        memo: "",
        checks: {}
    });
}

/* í…Œì´ë¸” ë Œë”ë§ */
function renderTable() {
    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");

    thead.innerHTML = `
        <tr>
            <th>ë‹‰ë„¤ì„</th>
            <th>ì•„ì´ë””</th>
            ${fields.map(f => `<th>${f} <button class='delete-btn' onclick="deleteField('${f}')">X</button></th>`).join("")}
            <th>ë©”ëª¨</th>
            <th>ì‚­ì œ</th>
        </tr>
    `;

    tbody.innerHTML = "";

    spacesRef.get().then(res => {
        res.forEach(doc => {
            const data = doc.data();
            const checks = data.checks || {};

            const row = document.createElement("tr");

            row.innerHTML = `
                <td><input value="${data.nickname}" onchange="update('${doc.id}', 'nickname', this.value)"></td>
                <td><input value="${data.userid}" onchange="update('${doc.id}', 'userid', this.value)"></td>
                ${fields.map(f => `
                    <td>
                        <input type="checkbox"
                            ${checks[f] ? "checked" : ""}
                            onchange="updateCheck('${doc.id}', '${f}', this.checked)">
                    </td>`).join("")}
                <td><textarea onchange="update('${doc.id}', 'memo', this.value)">${data.memo || ""}</textarea></td>
                <td><button class="delete-btn" onclick="deleteRow('${doc.id}')">ì‚­ì œ</button></td>
            `;

            tbody.appendChild(row);
        });
    });
}

/* ë°ì´í„° ì—…ë°ì´íŠ¸ */
function update(id, field, value) {
    spacesRef.doc(id).update({ [field]: value });
}

/* ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸ */
function updateCheck(id, field, value) {
    spacesRef.doc(id).update({ [`checks.${field}`]: value });
}

/* í–‰ ì‚­ì œ */
function deleteRow(id) {
    if (confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) spacesRef.doc(id).delete();
}
</script>

</body>
</html>
